From e8d4ea0861dba1c59ffef9595a686158ec4c9193 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Sat, 28 Nov 2015 00:14:20 +0000
Subject: [PATCH 1/3] Tiny optimisations

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 pisi/db/installdb.py     |  2 +-
 pisi/db/packagedb.py     |  2 +-
 pisi/operations/build.py | 11 +++++++++--
 3 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/pisi/db/installdb.py b/pisi/db/installdb.py
index b31acf5..62df263 100644
--- a/pisi/db/installdb.py
+++ b/pisi/db/installdb.py
@@ -261,7 +261,7 @@ class InstallDB(lazydb.LazyDB):
     def get_package_by_pkgconfig(self, pkgconfig):
         for item in self.list_installed():
             pkg = self.get_package(item)
-            if pkg.providesPkgConfig:
+            if pkg.providesPkgConfig is not None and len(pkg.providesPkgConfig) > 0:
                 for pc in pkg.providesPkgConfig:
                     if pc.om == pkgconfig:
                         return pkg
diff --git a/pisi/db/packagedb.py b/pisi/db/packagedb.py
index c682b9b..ad1ecd3 100644
--- a/pisi/db/packagedb.py
+++ b/pisi/db/packagedb.py
@@ -87,7 +87,7 @@ class PackageDB(lazydb.LazyDB):
     def get_package_by_pkgconfig(self, pkgconfig):
         for item in self.list_packages(None):
             pkg = self.get_package(item)
-            if pkg.providesPkgConfig:
+            if pkg.providesPkgConfig is not None and len(pkg.providesPkgConfig) > 0:
                 for pc in pkg.providesPkgConfig:
                     if pc.om == pkgconfig:
                         return pkg
diff --git a/pisi/operations/build.py b/pisi/operations/build.py
index 2314b3a..8800ea6 100644
--- a/pisi/operations/build.py
+++ b/pisi/operations/build.py
@@ -248,6 +248,7 @@ class Builder:
         self.componentdb = pisi.db.componentdb.ComponentDB()
         self.installdb = pisi.db.installdb.InstallDB()
         self.packagedb = pisi.db.packagedb.PackageDB()
+        self.filesdb = pisi.db.filesdb.FilesDB()
 
         # process args
         if not isinstance(specuri, pisi.uri.URI):
@@ -975,6 +976,11 @@ class Builder:
 
         return debug_package_obj
 
+    def _search_file(self, term):
+        if term.startswith("/"):
+            term = term[1:]
+        return self.filesdb.search_file(term)
+
     def get_binary_deps(self, path):
         bin_deps = list()
         if not os.path.exists(path):
@@ -1021,9 +1027,9 @@ class Builder:
                         result = self._bindeps_cache[dep2]
                     else:
                         # First time looking at this dep
-                        result = pisi.api.search_file(dep)
+                        result = self._search_file(dep)
                         if not result:
-                            result = pisi.api.search_file(dep2)
+                            result = self._search_file(dep2)
                             if result:
                                 self._bindeps_cache[dep2] = result
                         else:
@@ -1062,6 +1068,7 @@ class Builder:
         # on new installed build dependencies
         self.installdb = pisi.db.installdb.InstallDB()
         self.packagedb = pisi.db.packagedb.PackageDB()
+        self.filesdb = pisi.db.filesdb.FilesDB()
 
         knownPcFiles = list()
         for fileinfo in self.files.list:
-- 
2.6.4

